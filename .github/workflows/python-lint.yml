name: Python Lint, Import Sort, Typing

on:
  pull_request:
    branches:
      - '**'

jobs:
  # -----------------------------
  # Continuous Integration (CI)
  # -----------------------------
  lint-import-typing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 isort mypy requests
          pip install types-requests

      - name: Run flake8 (Python linter)
        run: |
          # Example: To exclude error E501 (line too long), add --ignore=E501
          flake8 . --count --show-source --statistics --max-line-length 120
        # To exclude a specific error in future, use:
        # flake8 . --count --show-source --statistics --ignore=E501

      - name: Run isort (import sorter)
        run: |
          isort . --check --diff --line-length=120

      - name: Run mypy (type checker)
        run: |
          mypy . --strict --ignore-missing-imports

    # Workflow will fail if any step returns a non-zero exit code

  # -----------------------------
  # Continuous Deployment (CD)
  # -----------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: lint-import-typing
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Upload model artifacts to S3
        run: |
          aws s3 cp ./model_artifacts/model.tar.gz s3://your-s3-bucket-name/model/model-$(date +%s).tar.gz
        env:
          AWS_REGION: us-east-2

      - name: Update SageMaker endpoint
        run: |
          python scripts/update_sagemaker_endpoint.py
        env:
          AWS_REGION: us-east-2
          SAGEMAKER_ENDPOINT_NAME: your-endpoint-name  # CHANGE THIS
          MODEL_S3_PATH: s3://your-s3-bucket-name/model/model-$(date +%s).tar.gz

      - name: Restart EC2 service (if applicable)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu # CHANGE if your EC2 uses 'ec2-user' or other user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Restarting web service..."
            sudo systemctl restart myapp || true  # CHANGE 'myapp' to your EC2 service name
            echo "Service restarted successfully."

      - name: Notify API Gateway (optional)
        run: |
          echo "Triggering API Gateway redeployment..."
          aws apigateway create-deployment --rest-api-id your-api-id --stage-name prod
