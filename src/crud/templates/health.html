<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Health Check - CloudWatch Logs Monitor"
    />
    <title>Health Check - BoilerFace</title>
    <style>
      /* CSS Reset and Base Styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        padding: 2rem;
        background: #f0f2f5;
        color: #1a1a1a;
      }

      /* Skip Navigation Link */
      .skip-link {
        position: absolute;
        top: -40px;
        left: 0;
        background: #000;
        color: #fff;
        padding: 8px;
        text-decoration: none;
        z-index: 100;
      }

      .skip-link:focus {
        top: 0;
      }

      /* Main Heading */
      h1 {
        text-align: center;
        color: #1a1a1a;
        margin-bottom: 2rem;
        font-size: 2rem;
      }

      h2 {
        color: #1a1a1a;
        margin-bottom: 1rem;
        font-size: 1.5rem;
      }

      h3 {
        color: #1a1a1a;
        margin-bottom: 0.5rem;
        font-size: 1.25rem;
      }

      /* Card Styling */
      .card {
        background: white;
        padding: 2rem;
        border-radius: 1rem;
        max-width: 1200px;
        margin: 1rem auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      /* Status Badge */
      .status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e5e7eb;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: bold;
        font-size: 0.875rem;
      }

      .status-badge.healthy {
        background: #d1fae5;
        color: #065f46;
        border: 2px solid #10b981;
      }

      .status-badge.error {
        background: #fee2e2;
        color: #991b1b;
        border: 2px solid #dc2626;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      .status-dot.healthy {
        background: #10b981;
      }

      .status-dot.error {
        background: #dc2626;
      }

      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Controls */
      .controls {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
      }

      .control-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .controls label {
        font-weight: bold;
        color: #374151;
        font-size: 0.875rem;
      }

      .controls select {
        padding: 0.5rem;
        border: 2px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        background: white;
        cursor: pointer;
        transition: border-color 0.2s;
      }

      .controls select:focus {
        outline: none;
        border-color: #4338ca;
      }

      .controls button {
        padding: 0.5rem 1rem;
        background: #4338ca;
        color: white;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: bold;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .controls button:hover {
        background: #3730a3;
      }

      .controls button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      /* Logs Container */
      .logs-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        color: #6b7280;
      }

      .logs-wrapper {
        background: #1a1a1a;
        border-radius: 0.5rem;
        padding: 1rem;
        max-height: 600px;
        overflow-y: auto;
      }

      .log-entry {
        display: grid;
        grid-template-columns: 150px 80px 1fr;
        gap: 1rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: #2d2d2d;
        border-radius: 0.25rem;
        border-left: 3px solid #6b7280;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        transition: background 0.2s;
      }

      .log-entry:hover {
        background: #3a3a3a;
      }

      .log-entry.ERROR {
        border-left-color: #dc2626;
        background: #2d1a1a;
      }

      .log-entry.WARNING {
        border-left-color: #f59e0b;
        background: #2d2a1a;
      }

      .log-entry.DEBUG {
        border-left-color: #3b82f6;
        background: #1a1f2d;
      }

      .log-timestamp {
        color: #9ca3af;
        white-space: nowrap;
      }

      .log-level {
        font-weight: bold;
        text-align: center;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
      }

      .log-level.INFO {
        background: #1e40af;
        color: #dbeafe;
      }

      .log-level.ERROR {
        background: #991b1b;
        color: #fee2e2;
      }

      .log-level.WARNING {
        background: #92400e;
        color: #fef3c7;
      }

      .log-level.DEBUG {
        background: #1e3a8a;
        color: #dbeafe;
      }

      .log-message {
        color: #e5e7eb;
        word-wrap: break-word;
        overflow-wrap: break-word;
      }

      .no-logs {
        text-align: center;
        padding: 3rem;
        color: #9ca3af;
      }

      .no-logs-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
      }

      /* Loading Spinner */
      .spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Error Message */
      .error-message {
        background: #fee2e2;
        color: #991b1b;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 2px solid #dc2626;
        margin-bottom: 1rem;
      }

      /* Back Link */
      .back-link {
        display: inline-block;
        margin-bottom: 1rem;
        color: #4338ca;
        text-decoration: none;
        font-weight: bold;
        transition: color 0.2s;
      }

      .back-link:hover {
        color: #3730a3;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .log-entry {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }

        .controls {
          flex-direction: column;
          align-items: stretch;
        }

        .control-group {
          width: 100%;
        }

        .controls select,
        .controls button {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <!-- Skip Navigation Link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Main Header -->
    <header role="banner">
      <h1>üè• Health Check & Logs Monitor</h1>
      <div style="text-align: center;">
        <a href="/" class="back-link">‚Üê Back to Main Page</a>
      </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" role="main">
      <!-- Health Status Card -->
      <section class="card">
        <div class="status-header">
          <div>
            <h2>System Status</h2>
            <p style="color: #6b7280; font-size: 0.875rem;">
              Real-time CloudWatch logs from FastAPI
            </p>
          </div>
          <div id="statusBadge" class="status-badge healthy">
            <span class="status-dot healthy"></span>
            <span>Healthy</span>
          </div>
        </div>

        <!-- Controls -->
        <div class="controls">
          <div class="control-group">
            <label for="logLimit">Limit:</label>
            <select id="logLimit">
              <option value="50">50 logs</option>
              <option value="100" selected>100 logs</option>
              <option value="200">200 logs</option>
              <option value="500">500 logs</option>
            </select>
          </div>

          <button id="refreshBtn" onclick="fetchLogs()">
            <span>üîÑ</span>
            <span>Refresh</span>
          </button>

          <button onclick="toggleAutoRefresh()">
            <span id="autoRefreshIcon">‚ñ∂Ô∏è</span>
            <span id="autoRefreshText">Auto-refresh OFF</span>
          </button>
        </div>

        <!-- Error Message -->
        <div id="errorContainer"></div>

        <!-- Logs Info -->
        <div class="logs-info">
          <span id="logCount">Loading logs...</span>
          <span id="lastUpdate"></span>
        </div>

        <!-- Logs Display -->
        <div class="logs-wrapper" id="logsContainer">
          <div class="no-logs">
            <div class="no-logs-icon">‚è≥</div>
            <div>Loading logs from CloudWatch...</div>
          </div>
        </div>
      </section>
    </main>

    <script>
      let autoRefreshInterval = null;
      let isAutoRefresh = false;

      // Fetch logs on page load
      window.addEventListener('DOMContentLoaded', () => {
        fetchLogs();
        
        // Add event listeners to dropdowns to auto-fetch when changed
        document.getElementById('timeRange').addEventListener('change', fetchLogs);
        document.getElementById('logLimit').addEventListener('change', fetchLogs);
      });

      async function fetchLogs() {
        const timeRange = 1;
        const logLimit = document.getElementById('logLimit').value;
        const logsContainer = document.getElementById('logsContainer');
        const refreshBtn = document.getElementById('refreshBtn');
        const errorContainer = document.getElementById('errorContainer');
        const statusBadge = document.getElementById('statusBadge');

        // Show what we're fetching in console for debugging
        console.log(`Fetching logs: hours=${timeRange}, limit=${logLimit}`);

        // Disable refresh button and show loading
        refreshBtn.disabled = true;
        errorContainer.innerHTML = '';

        try {
          const response = await fetch(`/health/logs?hours=${timeRange}&limit=${logLimit}`);
          const data = await response.json();

          console.log('Received data:', data); // Debug log

          if (!response.ok) {
            throw new Error(data.detail || 'Failed to fetch logs');
          }

          // Update status badge
          if (data.status === 'healthy') {
            statusBadge.className = 'status-badge healthy';
            statusBadge.innerHTML = '<span class="status-dot healthy"></span><span>Healthy</span>';
          } else {
            statusBadge.className = 'status-badge error';
            statusBadge.innerHTML = '<span class="status-dot error"></span><span>Error</span>';
          }

          // Update log count and timestamp
          document.getElementById('logCount').textContent = `Showing ${data.total} log entries`;
          document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

          // Display logs
          if (data.logs && data.logs.length > 0) {
            logsContainer.innerHTML = data.logs.map(log => `
              <div class="log-entry ${log.level}">
                <div class="log-timestamp">${escapeHtml(log.timestamp)}</div>
                <div class="log-level ${log.level}">${log.level}</div>
                <div class="log-message">${escapeHtml(log.message)}</div>
              </div>
            `).join('');
          } else {
            logsContainer.innerHTML = `
              <div class="no-logs">
                <div class="no-logs-icon">üì≠</div>
                <div>No logs found in the selected time range</div>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error fetching logs:', error);
          errorContainer.innerHTML = `
            <div class="error-message">
              <strong>Error:</strong> ${escapeHtml(error.message)}
            </div>
          `;
          logsContainer.innerHTML = `
            <div class="no-logs">
              <div class="no-logs-icon">‚ùå</div>
              <div>Failed to load logs. Please check your CloudWatch configuration.</div>
            </div>
          `;
          statusBadge.className = 'status-badge error';
          statusBadge.innerHTML = '<span class="status-dot error"></span><span>Error</span>';
        } finally {
          refreshBtn.disabled = false;
        }
      }

      function toggleAutoRefresh() {
        isAutoRefresh = !isAutoRefresh;
        const icon = document.getElementById('autoRefreshIcon');
        const text = document.getElementById('autoRefreshText');

        if (isAutoRefresh) {
          icon.textContent = '‚è∏Ô∏è';
          text.textContent = 'Auto-refresh ON';
          autoRefreshInterval = setInterval(fetchLogs, 10000); // Refresh every 10 seconds
          fetchLogs(); // Fetch immediately
        } else {
          icon.textContent = '‚ñ∂Ô∏è';
          text.textContent = 'Auto-refresh OFF';
          if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
          }
        }
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    </script>
  </body>
</html>